<% content_for :stylesheets do %>
	<%= stylesheet_link_tag "new" %>
	<%= stylesheet_link_tag "form" %>	
	<%= stylesheet_link_tag "overview" %>	
	<%= stylesheet_link_tag "timeline" %>	

<% end %>


<% content_for :javascripts do %>

<%= javascript_include_tag "timeline.js" %>

<script type="text/javascript" charset="utf-8">

	function add_url() {
		console.log("here");
		
		
		var text = $("#urls").val();
		console.log(text);
		$("#loader").show();
		
		
		jQuery.ajax({
        type: "POST",
        url: "<%= url_for :controller => "trails", :action => "process_urls"  %>",
        dataType:"html",
        data:{urls : text },
        success:function(data){
					$("#articles").append(data);
					$("#loader").hide();
					
					var offset = $(".article:last").offset();
					
					// minus half the size of the close button...and then some small padding.
					window.scrollTo(offset.left, offset.top - 50);
        },
        error:function (xhr, ajaxOptions, thrownError){
					alert("Error Occured");
        }    
    });
    
		$("#urls").text("");
		
	}
	
	function add_url_keydown(event) {
		if(event.which == 13) {
			add_url();
			return false;
		}
	}
	
	function trail_close() {
		$(this).parents(".article").remove();
	}
	
	function initSortables() {
		console.log("Here!");
		
		$("#articles").sortable( {
			axis: 'y',
			containment: '#articles',
			cursor: 'move',
			handle: '.header',
		});
	}
	
	
	function next_thumbnail() {
		console.log("next");
				
		var li = $(this).parents(".article").find("li.selected");
		$(li).removeClass("selected");
		$(li).next().addClass("selected")
		
		if($(li).siblings(".selected").size() == 0) {
			$(this).parents(".article").find("li:first").addClass("selected");
		}
		
		 var url = $(this).parents(".article").find("li.selected").text();
		$(this).parents(".article").find(".thumbnail img").attr("src", url);
		
		
		
		return false;
		
	}
	
	function prev_thumbnail() {
		console.log("prev");
		
		
		var li = $(this).parents(".article").find("li.selected");
		$(li).removeClass("selected");
		$(li).prev().addClass("selected")
		
		if($(li).siblings(".selected").size() == 0) {
			$(this).parents(".article").find("li:last").addClass("selected");
		}
		
		 var url = $(this).parents(".article").find("li.selected").text();
		$(this).parents(".article").find(".thumbnail img").attr("src", url);
		
		return false;
	}

	$(function() {
		
		
		
		$('.article .next').livequery('click', next_thumbnail);
		$('.article .prev').livequery('click', prev_thumbnail);
		$('.article .close').livequery('click', trail_close);
		
		
		$("#urls").keypress(add_url_keydown);
		$("#add_urls").click(add_url);
		
		$(".url_text").Watermark("url");
		$(".subtitle_text").Watermark("your thoughts...");   
		
		initSortables();
		
		$("#add_button").click(function() {
			
			var dom = '<div class="trail_item"> \
				<div class="trail_close"></div>	\
				<div class="trail_handle"></div> \
\
 				<div class="trail_form"> \
					<p> \
						<input type="text" name="url" value="" class="url_text"> \
					</p> \
					<p> \
						<textarea name="subtitle" rows="3" cols="40" class="subtitle_text"></textarea> \
						<!-- ><input tye="text" name="url" value="" class="subtitle_text"> --> \
					</p> \
				</div> \
			</div>';
			
			$("#trail").append(dom);
			
			$(".url_text").Watermark("url");
			$(".subtitle_text").Watermark("your thoughts...");   

			$(".trail_close").click(trail_close);

			initSortables();
			
		});
				
		$("#submit_button").click(function() {
			
			//$.Watermark.HideAll();
	   
			
			var data = { title: "", links: [] };
			data["title"] = $("#title").val();
			
			$(".trail_item").each(function(item) {
				var url = $(".url_text", item).val();
				var comment = $(".subtitle_text", item).val();
				var item = { "url" : url, "comment" : comment };

				data["links"].push(item);				
			});
			
			var string = JSON.stringify(data);
			alert(string);
			
			//$.Watermark.ShowAll();
			
			$("#loader").show();
	   	$.post("<%= url_for :controller => "home", :action => "submit"  %>", {trail : data }, function() { 
				$("#loader").hide(); 
				$("#trail_input").val(string); 
				$("#post_back").submit();
			}, "script");
			
		});
		
		
	});
</script>




<% end %>


<h2>Create New Trail <span style="font-size:12px; font-weight:normal">(<%= link_to "Other ways to create trails", :controller => "home", :action => "jetpack" %>)</span></h2>


<fieldset>

	<div class="small_columns">
		<div class="maincol">
			<label for="title" class="large_label" >Trail Title:</label>
			<input type="text" name="title" value="<%= params[:title] %>" style="width:100%" id="title" class="large_text">
		</div>
		<div class="sidecol">
			<div class="round_box" style="margin-top:15px">
				150 Characters Remaining
			</div>
		</div>
		<div class="clear"></div>
	</div>

</fieldset>


<fieldset style="">
	
	<div class="small_columns">
		<div class="maincol">
			
			<%= image_tag "loader.gif", :style => "float:right;", :id => "loader" %>
			<label for="urls" class="large_label" >URLs:</label>
						
			<div id="articles">
				<% 0.times do %>
	
				<%= render :partial => "article", :locals => 	{
			      :url => "http://www.google.com",
			      :header => "Some header information",

			      :date => Time.now.rfc2822,
			      :source => "cnn.com",

			      :notes => "\"This is a sample paragraph that is included\"",
						:urls => [
								"http://www.google.com/intl/en_ALL/images/logo.gif",
								"http://l.yimg.com/g/images/logo_home.png.v2",
								"http://a1.twimg.com/a/1264119427/images/logo.png"
							]
			    } %>
	
				<% end %>
				
			</div>
			
			
			
			<input type="button" id="add_urls" class="url_add_button" value="Add">
			<textarea name="urls" id="urls" id="urls" class="large_text" style="width:520px;resize:none;height:75px;"><%= params[:urls] %></textarea>
			
			<div class="space_20"></div>
	
	
	
		</div>
		<div class="sidecol">
			<div class="round_box" style="margin-top:15px">
				Type or paste in as many URLs as you want and hit <b>Enter</b> to add them to your trail.				
			</div>
		</div>
		<div class="clear"></div>
	</div>
	
	
</fieldset>


<div id="timeline">
	
	
	<div class="meta">
		<div class="headline">
			&nbsp;
		</div>
		<div class="source">
			&nbsp;
		</div>
	</div>
	<div class="meta_callout">&nbsp;</div>
	
	
	<div class="empty">
		No Events
	</div>			

	<div id="scale">&nbsp;</div>
</div>


<div id="buttons">
				
		<% form_tag({:controller => "home", :action => "preview" }, {:id => "post_back"})  do %>
			<input type="hidden" name="trail" value="" id="trail_input"> 
		<% end %>
	
		<%= button_to "Create", {:controller => "trails", :action => "show"}, { :class => "trail_button"} %>
		

</div>


